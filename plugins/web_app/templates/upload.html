{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>æ–‡ä»¶ä¸Šä¼ ä¸è½¬æ¢</h2>
    
    <!-- åŠŸèƒ½è¯´æ˜ -->
    <div class="info-section">
        <h3>åŠŸèƒ½è¯´æ˜</h3>
        <p>æœ¬ç³»ç»Ÿæ”¯æŒè§†é¢‘å’ŒéŸ³é¢‘æ–‡ä»¶çš„æ™ºèƒ½è½¬æ¢å¤„ç†ï¼Œæä¾›ä»¥ä¸‹ä¸‰ç§è½¬æ¢æ¨¡å¼ï¼š</p>
        <ul>
            <li><strong>MP4 è½¬ MP3</strong>ï¼šå°†è§†é¢‘æ–‡ä»¶æå–éŸ³é¢‘å¹¶è½¬æ¢ä¸ºMP3æ ¼å¼ï¼Œæ”¯æŒå‚æ•°ä¼˜åŒ–ä»¥å‡å°æ–‡ä»¶å¤§å°</li>
            <li><strong>MP3 è½¬æ–‡å­—</strong>ï¼šä½¿ç”¨é˜¿é‡Œäº‘æ™ºèƒ½è¯­éŸ³è¯†åˆ«æœåŠ¡ï¼Œå°†éŸ³é¢‘è½¬æ¢ä¸ºæ–‡å­—å’ŒSRTå­—å¹•æ–‡ä»¶</li>
            <li><strong>MP4 è½¬æ–‡å­—</strong>ï¼šå®Œæ•´æµç¨‹ï¼Œå…ˆå°†è§†é¢‘è½¬æ¢ä¸ºéŸ³é¢‘ï¼Œå†è¿›è¡Œè¯­éŸ³è¯†åˆ«è½¬æ¢ä¸ºæ–‡å­—</li>
        </ul>
    </div>
    
    <!-- æ–‡ä»¶æ ¼å¼æ”¯æŒè¯´æ˜ -->
    <div class="info-section">
        <h3>æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</h3>
        <div class="format-grid">
            <div class="format-category">
                <h4>è§†é¢‘æ ¼å¼</h4>
                <div class="format-list">
                    <span class="format-tag">MP4</span>
                    <span class="format-tag">AVI</span>
                    <span class="format-tag">MOV</span>
                    <span class="format-tag">MKV</span>
                    <span class="format-tag">FLV</span>
                    <span class="format-tag">WMV</span>
                </div>
                <p class="format-desc">æ”¯æŒä¸»æµè§†é¢‘æ ¼å¼ï¼Œæ¨èä½¿ç”¨MP4æ ¼å¼ä»¥è·å¾—æœ€ä½³å…¼å®¹æ€§</p>
            </div>
            
            <div class="format-category">
                <h4>éŸ³é¢‘æ ¼å¼</h4>
                <div class="format-list">
                    <span class="format-tag">MP3</span>
                    <span class="format-tag">WAV</span>
                    <span class="format-tag">FLAC</span>
                    <span class="format-tag">AAC</span>
                </div>
                <p class="format-desc">æ”¯æŒå¸¸è§éŸ³é¢‘æ ¼å¼ï¼Œæ¨èä½¿ç”¨MP3æˆ–WAVæ ¼å¼ä»¥è·å¾—æœ€ä½³è¯†åˆ«æ•ˆæœ</p>
            </div>
        </div>
    </div>
    
    <!-- æ–‡ä»¶å¤§å°å’Œè´¨é‡è¯´æ˜ -->
    <div class="info-section">
        <h3>æ–‡ä»¶å¤§å°é™åˆ¶</h3>
        <div class="size-info">
            <div class="size-limit">
                <span class="size-number">10GB</span>
                <span class="size-label">æœ€å¤§æ–‡ä»¶å¤§å°</span>
            </div>
            <div class="size-recommendations">
                <h4>å»ºè®®</h4>
                <ul>
                    <li>è§†é¢‘æ–‡ä»¶ï¼šå»ºè®®åˆ†è¾¨ç‡ä¸è¶…è¿‡1080Pï¼Œç ç‡é€‚ä¸­ä»¥å¹³è¡¡æ–‡ä»¶å¤§å°å’Œè´¨é‡</li>
                    <li>éŸ³é¢‘æ–‡ä»¶ï¼šå»ºè®®é‡‡æ ·ç‡16kHzæˆ–ä»¥ä¸Šï¼Œä»¥è·å¾—æ›´å¥½çš„è¯­éŸ³è¯†åˆ«æ•ˆæœ</li>
                    <li>æ–‡ä»¶æ—¶é•¿ï¼šå»ºè®®å•ä¸ªæ–‡ä»¶æ—¶é•¿ä¸è¶…è¿‡2å°æ—¶ï¼Œä»¥ç¡®ä¿å¤„ç†æ•ˆç‡</li>
                    <li>è¯­éŸ³è´¨é‡ï¼šæ¸…æ™°çš„è¯­éŸ³å½•éŸ³å°†è·å¾—æ›´å‡†ç¡®çš„è¯†åˆ«ç»“æœ</li>
                </ul>
            </div>
        </div>
    </div>
    
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">é€‰æ‹©æ–‡ä»¶</label>
            <div class="file-input-wrapper">
                <input type="file" id="file" name="file" accept=".mp4,.avi,.mov,.mkv,.flv,.wmv,.mp3,.wav,.flac,.aac" required>
                <div class="file-input-overlay">
                    <div class="file-input-icon">ğŸ“</div>
                    <div class="file-input-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                    <div class="file-input-subtext">æ”¯æŒ MP4, AVI, MOV, MKV, FLV, WMV, MP3, WAV, FLAC, AAC</div>
                </div>
            </div>
            
            <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º -->
            <div id="file-info-display" class="file-info-display hidden">
                <div class="file-details">
                    <div class="file-name">
                        <span class="file-icon">ğŸ“„</span>
                        <span id="selected-file-name">æœªé€‰æ‹©æ–‡ä»¶</span>
                    </div>
                    <div class="file-size-display">
                        <span id="selected-file-size">0 Bytes</span>
                        <span class="size-separator">/</span>
                        <span class="max-size">10 GB</span>
                    </div>
                    <div class="file-size-bar">
                        <div class="size-bar-bg">
                            <div id="file-size-progress" class="size-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="size-percentage" id="size-percentage">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- æ–‡ä»¶å¤§å°è­¦å‘Š -->
            <div id="file-size-warning" class="alert alert-warning hidden">
                <strong>âš ï¸ è­¦å‘Šï¼š</strong>é€‰æ‹©çš„æ–‡ä»¶å¤§å°è¶…è¿‡10GBé™åˆ¶ï¼è¯·é€‰æ‹©è¾ƒå°çš„æ–‡ä»¶ã€‚
            </div>
            
            <!-- æ–‡ä»¶ç±»å‹é”™è¯¯ -->
            <div id="file-type-error" class="alert alert-danger hidden">
                <strong>âŒ é”™è¯¯ï¼š</strong>ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·é€‰æ‹©æ”¯æŒçš„è§†é¢‘æˆ–éŸ³é¢‘æ–‡ä»¶ã€‚
            </div>
        </div>
        
        <div class="form-group">
            <label for="conversion_type">è½¬æ¢ç±»å‹</label>
            <select id="conversion_type" name="conversion_type" required>
                <option value="">è¯·é€‰æ‹©è½¬æ¢ç±»å‹</option>
                <option value="mp4_to_mp3">MP4 è½¬ MP3 - æå–è§†é¢‘ä¸­çš„éŸ³é¢‘</option>
                <option value="mp3_to_txt">MP3 è½¬æ–‡å­— - è¯­éŸ³è¯†åˆ«è½¬æ¢ä¸ºæ–‡å­—</option>
                <option value="mp4_to_txt">MP4 è½¬æ–‡å­— - å®Œæ•´æµç¨‹ï¼ˆè§†é¢‘â†’éŸ³é¢‘â†’æ–‡å­—ï¼‰</option>
            </select>
            <div class="conversion-help">
                <small class="text-muted">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>
                    <br>â€¢ MP4è½¬MP3ï¼šå¿«é€Ÿæå–éŸ³é¢‘ï¼Œé€‚åˆéœ€è¦éŸ³é¢‘æ–‡ä»¶çš„åœºæ™¯
                    <br>â€¢ MP3è½¬æ–‡å­—ï¼šç›´æ¥å¤„ç†éŸ³é¢‘æ–‡ä»¶ï¼Œç”Ÿæˆæ–‡å­—å’Œå­—å¹•
                    <br>â€¢ MP4è½¬æ–‡å­—ï¼šä¸€ç«™å¼å¤„ç†ï¼Œä»è§†é¢‘ç›´æ¥å¾—åˆ°æ–‡å­—å†…å®¹
                </small>
            </div>
        </div>
        
        <div class="form-group" id="engine-selection" style="display: none;">
            <label for="conversion_engine">è½¬æ¢å¼•æ“</label>
            <select id="conversion_engine" name="conversion_engine">
                <option value="alibaba_nls">é˜¿é‡Œäº‘ NLS - äº‘ç«¯è¯­éŸ³è¯†åˆ«æœåŠ¡</option>
                <option value="whisper">Fast Whisper - æœ¬åœ°è¯­éŸ³è¯†åˆ«æ¨¡å‹</option>
            </select>
            <div class="engine-help">
                <small class="text-muted">
                    <strong>ğŸ”§ å¼•æ“å¯¹æ¯”ï¼š</strong>
                    <br>â€¢ é˜¿é‡Œäº‘NLSï¼šäº‘ç«¯å¤„ç†ï¼Œè¯†åˆ«å‡†ç¡®åº¦é«˜ï¼Œéœ€è¦ç½‘ç»œè¿æ¥
                    <br>â€¢ Fast Whisperï¼šæœ¬åœ°å¤„ç†ï¼Œç¦»çº¿å¯ç”¨ï¼Œæ”¯æŒå¤šç§è¯­è¨€
                </small>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn" id="submit-btn" disabled>è¯·å…ˆé€‰æ‹©æ–‡ä»¶</button>
        </div>
    </form>
    
    <!-- ä¸Šä¼ è¿›åº¦åŒºåŸŸ -->
    <div id="upload-progress-section" class="progress-section hidden">
        <h3>ğŸ“¤ æ–‡ä»¶ä¸Šä¼ è¿›åº¦</h3>
        <div class="progress-container">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="upload-progress-bar" style="width: 0%"></div>
                <div class="progress-text" id="upload-progress-text">0%</div>
            </div>
            <div class="progress-details">
                <span id="upload-speed">ä¸Šä¼ é€Ÿåº¦: 0 MB/s</span>
                <span id="upload-eta">é¢„è®¡å‰©ä½™æ—¶é—´: --</span>
            </div>
        </div>
    </div>
    
    <!-- è½¬æ¢è¿›åº¦åŒºåŸŸ -->
    <div id="conversion-progress-section" class="progress-section hidden">
        <h3>âš™ï¸ è½¬æ¢è¿›åº¦</h3>
        <div class="progress-container">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="conversion-progress-bar" style="width: 0%"></div>
                <div class="progress-text" id="conversion-progress-text">0%</div>
            </div>
            <div class="progress-status" id="conversion-status">å‡†å¤‡ä¸­...</div>
        </div>
    </div>
    
    <!-- ç»“æœåŒºåŸŸ -->
    <div id="result-section" class="result-section hidden">
        <h3>ğŸ“‹ è½¬æ¢ç»“æœ</h3>
        <div id="result-content"></div>
    </div>
</div>

<div class="card">
    <h2>æ­£åœ¨è¿›è¡Œçš„è½¬æ¢</h2>
    <div id="active-conversions">
        <p>æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„è½¬æ¢</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// é…ç½®å¸¸é‡
const MAX_FILE_SIZE = 10 * 1024 * 1024 * 1024; // 10GB
const SUPPORTED_EXTENSIONS = ['.mp4', '.avi', '.mov', '.mkv', '.flv', '.wmv', '.mp3', '.wav', '.flac', '.aac'];

// å…¨å±€å˜é‡
let selectedFile = null;
let uploadStartTime = null;
let uploadXHR = null;
let socket = null;
let currentConversionId = null;

// DOM å…ƒç´ 
const fileInput = document.getElementById('file');
const fileInfoDisplay = document.getElementById('file-info-display');
const fileSizeWarning = document.getElementById('file-size-warning');
const fileTypeError = document.getElementById('file-type-error');
const submitBtn = document.getElementById('submit-btn');
const uploadForm = document.getElementById('uploadForm');

// æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å‡½æ•°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// è®¡ç®—ä¸Šä¼ é€Ÿåº¦
function calculateUploadSpeed(uploadedBytes, startTime) {
    const currentTime = Date.now();
    const elapsedTime = (currentTime - startTime) / 1000; // ç§’
    const speed = uploadedBytes / elapsedTime; // å­—èŠ‚/ç§’
    return speed;
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(seconds) {
    if (!seconds || seconds === Infinity) return '--';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}åˆ†${remainingSeconds}ç§’`;
}

// éªŒè¯æ–‡ä»¶æ ¼å¼
function validateFileType(filename) {
    const extension = '.' + filename.split('.').pop().toLowerCase();
    return SUPPORTED_EXTENSIONS.includes(extension);
}

// éªŒè¯æ–‡ä»¶å¤§å°
function validateFileSize(size) {
    return size <= MAX_FILE_SIZE;
}

// æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
function updateFileDisplay(file) {
    if (!file) {
        fileInfoDisplay.classList.add('hidden');
        return;
    }
    
    const fileName = file.name;
    const fileSize = file.size;
    const sizePercentage = (fileSize / MAX_FILE_SIZE) * 100;
    
    document.getElementById('selected-file-name').textContent = fileName;
    document.getElementById('selected-file-size').textContent = formatFileSize(fileSize);
    document.getElementById('file-size-progress').style.width = Math.min(sizePercentage, 100) + '%';
    document.getElementById('size-percentage').textContent = sizePercentage.toFixed(1) + '%';
    
    // è®¾ç½®è¿›åº¦æ¡é¢œè‰²
    const progressBar = document.getElementById('file-size-progress');
    if (sizePercentage > 90) {
        progressBar.style.backgroundColor = '#dc3545'; // çº¢è‰²
    } else if (sizePercentage > 70) {
        progressBar.style.backgroundColor = '#ffc107'; // é»„è‰²
    } else {
        progressBar.style.backgroundColor = '#28a745'; // ç»¿è‰²
    }
    
    fileInfoDisplay.classList.remove('hidden');
}

// é‡ç½®è­¦å‘Šå’Œé”™è¯¯ä¿¡æ¯
function resetValidationMessages() {
    fileSizeWarning.classList.add('hidden');
    fileTypeError.classList.add('hidden');
}

// éªŒè¯å¹¶æ›´æ–°UI
function validateAndUpdateUI(file) {
    resetValidationMessages();
    
    if (!file) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶';
        return false;
    }
    
    // éªŒè¯æ–‡ä»¶ç±»å‹
    if (!validateFileType(file.name)) {
        fileTypeError.classList.remove('hidden');
        submitBtn.disabled = true;
        submitBtn.textContent = 'ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼';
        return false;
    }
    
    // éªŒè¯æ–‡ä»¶å¤§å°
    if (!validateFileSize(file.size)) {
        fileSizeWarning.classList.remove('hidden');
        submitBtn.disabled = true;
        submitBtn.textContent = 'æ–‡ä»¶è¿‡å¤§ï¼Œæ— æ³•ä¸Šä¼ ';
        return false;
    }
    
    // éªŒè¯é€šè¿‡
    submitBtn.disabled = false;
    submitBtn.textContent = 'å¼€å§‹è½¬æ¢';
    return true;
}

// æ–‡ä»¶é€‰æ‹©äº‹ä»¶å¤„ç†
fileInput.addEventListener('change', function(e) {
    selectedFile = e.target.files[0];
    updateFileDisplay(selectedFile);
    validateAndUpdateUI(selectedFile);
});

// è½¬æ¢ç±»å‹é€‰æ‹©äº‹ä»¶å¤„ç†
document.getElementById('conversion_type').addEventListener('change', function(e) {
    const conversionType = e.target.value;
    const engineSelection = document.getElementById('engine-selection');
    
    // åªæœ‰åœ¨é€‰æ‹©äº†æ–‡å­—è½¬æ¢ç±»å‹æ—¶æ‰æ˜¾ç¤ºå¼•æ“é€‰æ‹©
    if (conversionType === 'mp3_to_txt' || conversionType === 'mp4_to_txt') {
        engineSelection.style.display = 'block';
    } else {
        engineSelection.style.display = 'none';
    }
});

// æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
const fileInputWrapper = document.querySelector('.file-input-wrapper');

fileInputWrapper.addEventListener('dragover', function(e) {
    e.preventDefault();
    fileInputWrapper.classList.add('drag-over');
});

fileInputWrapper.addEventListener('dragleave', function(e) {
    e.preventDefault();
    fileInputWrapper.classList.remove('drag-over');
});

fileInputWrapper.addEventListener('drop', function(e) {
    e.preventDefault();
    fileInputWrapper.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        selectedFile = files[0];
        fileInput.files = files; // æ›´æ–°inputçš„files
        updateFileDisplay(selectedFile);
        validateAndUpdateUI(selectedFile);
    }
});

// ä¸Šä¼ è¿›åº¦æ›´æ–°å‡½æ•°
function updateUploadProgress(loaded, total) {
    const percentage = Math.round((loaded / total) * 100);
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    const uploadProgressText = document.getElementById('upload-progress-text');
    
    uploadProgressBar.style.width = percentage + '%';
    uploadProgressText.textContent = percentage + '%';
    
    // è®¡ç®—ä¸Šä¼ é€Ÿåº¦å’Œå‰©ä½™æ—¶é—´
    if (uploadStartTime) {
        const speed = calculateUploadSpeed(loaded, uploadStartTime);
        const speedMB = speed / (1024 * 1024);
        const remainingBytes = total - loaded;
        const eta = remainingBytes / speed;
        
        document.getElementById('upload-speed').textContent = `ä¸Šä¼ é€Ÿåº¦: ${speedMB.toFixed(2)} MB/s`;
        document.getElementById('upload-eta').textContent = `é¢„è®¡å‰©ä½™æ—¶é—´: ${formatTime(eta)}`;
    }
}

// è¡¨å•æäº¤å¤„ç†
uploadForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!selectedFile) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼');
        return;
    }
    
    // æœ€åä¸€æ¬¡éªŒè¯
    if (!validateAndUpdateUI(selectedFile)) {
        return;
    }
    
    const formData = new FormData(this);
    
    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
    document.getElementById('upload-progress-section').classList.remove('hidden');
    document.getElementById('conversion-progress-section').classList.add('hidden');
    document.getElementById('result-section').classList.add('hidden');
    
    // ç¦ç”¨æäº¤æŒ‰é’®
    submitBtn.disabled = true;
    submitBtn.textContent = 'ä¸Šä¼ ä¸­...';
    
    // è®°å½•ä¸Šä¼ å¼€å§‹æ—¶é—´
    uploadStartTime = Date.now();
    
    // åˆ›å»º XMLHttpRequest ä»¥æ”¯æŒè¿›åº¦è·Ÿè¸ª
    uploadXHR = new XMLHttpRequest();
    
    // ä¸Šä¼ è¿›åº¦ç›‘å¬
    uploadXHR.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            updateUploadProgress(e.loaded, e.total);
        }
    });
    
    // ä¸Šä¼ å®Œæˆç›‘å¬
    uploadXHR.addEventListener('load', function() {
        if (uploadXHR.status === 200) {
            try {
                const response = JSON.parse(uploadXHR.responseText);
                handleUploadSuccess(response);
            } catch (error) {
                handleUploadError('å“åº”è§£æé”™è¯¯: ' + error.message);
            }
        } else if (uploadXHR.status === 413) {
            try {
                const response = JSON.parse(uploadXHR.responseText);
                handleUploadError(response.message || 'æ–‡ä»¶è¿‡å¤§ï¼Œè¶…è¿‡ç³»ç»Ÿé™åˆ¶');
            } catch (error) {
                handleUploadError('æ–‡ä»¶è¿‡å¤§ï¼Œè¶…è¿‡ç³»ç»Ÿé™åˆ¶');
            }
        } else {
            handleUploadError('ä¸Šä¼ å¤±è´¥ï¼ŒæœåŠ¡å™¨å“åº”é”™è¯¯: ' + uploadXHR.status);
        }
    });
    
    // ä¸Šä¼ é”™è¯¯ç›‘å¬
    uploadXHR.addEventListener('error', function() {
        handleUploadError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    });
    
    // ä¸Šä¼ ä¸­æ­¢ç›‘å¬
    uploadXHR.addEventListener('abort', function() {
        handleUploadError('ä¸Šä¼ è¢«ä¸­æ­¢');
    });
    
    // å‘é€è¯·æ±‚
    uploadXHR.open('POST', '/api/convert');
    uploadXHR.send(formData);
});

// å¤„ç†ä¸Šä¼ æˆåŠŸ
function handleUploadSuccess(response) {
    if (response.success) {
        // éšè—ä¸Šä¼ è¿›åº¦ï¼Œæ˜¾ç¤ºè½¬æ¢è¿›åº¦
        document.getElementById('upload-progress-section').classList.add('hidden');
        document.getElementById('conversion-progress-section').classList.remove('hidden');
        
        currentConversionId = response.conversion_id;
        
        // åŠ å…¥WebSocketè½¬æ¢æˆ¿é—´
        if (socket) {
            socket.emit('join_conversion', { conversion_id: currentConversionId });
        }
    } else {
        handleUploadError(response.message || 'ä¸Šä¼ å¤±è´¥');
    }
}

// å¤„ç†ä¸Šä¼ é”™è¯¯
function handleUploadError(message) {
    document.getElementById('upload-progress-section').classList.add('hidden');
    document.getElementById('conversion-progress-section').classList.add('hidden');
    
    const resultContent = document.getElementById('result-content');
    resultContent.innerHTML = `
        <div class="alert alert-danger">
            <strong>âŒ ä¸Šä¼ å¤±è´¥ï¼š</strong>${message}
        </div>
    `;
    
    document.getElementById('result-section').classList.remove('hidden');
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    submitBtn.disabled = false;
    submitBtn.textContent = 'å¼€å§‹è½¬æ¢';
}



// WebSocket åˆå§‹åŒ–å’Œäº‹ä»¶å¤„ç†
function initWebSocket() {
    // åˆå§‹åŒ–Socket.IOè¿æ¥
    socket = io();
    
    // è¿æ¥çŠ¶æ€äº‹ä»¶
    socket.on('connect', function() {
        console.log('WebSocket connected');
    });
    
    socket.on('disconnect', function() {
        console.log('WebSocket disconnected');
    });
    
    socket.on('connection_status', function(data) {
        console.log('Connection status:', data);
    });
    
    // ä¸Šä¼ è¿›åº¦äº‹ä»¶
    socket.on('upload_progress', function(data) {
        if (data.conversion_id === currentConversionId) {
            updateUploadProgressFromSocket(data);
        }
    });
    
    // è½¬æ¢è¿›åº¦äº‹ä»¶
    socket.on('conversion_progress', function(data) {
        if (data.conversion_id === currentConversionId) {
            updateConversionProgressFromSocket(data);
        }
    });
    
    // è½¬æ¢å®Œæˆäº‹ä»¶
    socket.on('conversion_complete', function(data) {
        if (data.conversion_id === currentConversionId) {
            handleConversionCompleteFromSocket(data);
        }
    });
    
    // é”™è¯¯äº‹ä»¶
    socket.on('error', function(data) {
        if (data.conversion_id === currentConversionId) {
            handleErrorFromSocket(data);
        }
    });
    
    // è½¬æ¢çŠ¶æ€æ›´æ–°äº‹ä»¶
    socket.on('conversion_status', function(data) {
        if (data.id === currentConversionId) {
            updateConversionStatus(data);
        }
    });
}

// ä»WebSocketæ›´æ–°ä¸Šä¼ è¿›åº¦
function updateUploadProgressFromSocket(data) {
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    const uploadProgressText = document.getElementById('upload-progress-text');
    
    uploadProgressBar.style.width = data.percentage + '%';
    uploadProgressText.textContent = data.percentage + '%';
    
    if (data.speed) {
        const speedMB = data.speed / (1024 * 1024);
        document.getElementById('upload-speed').textContent = `ä¸Šä¼ é€Ÿåº¦: ${speedMB.toFixed(2)} MB/s`;
    }
    
    if (data.eta) {
        document.getElementById('upload-eta').textContent = `é¢„è®¡å‰©ä½™æ—¶é—´: ${formatTime(data.eta)}`;
    }
}

// ä»WebSocketæ›´æ–°è½¬æ¢è¿›åº¦
function updateConversionProgressFromSocket(data) {
    const conversionProgressBar = document.getElementById('conversion-progress-bar');
    const conversionProgressText = document.getElementById('conversion-progress-text');
    const conversionStatus = document.getElementById('conversion-status');
    
    conversionProgressBar.style.width = data.progress + '%';
    conversionProgressText.textContent = data.progress + '%';
    conversionStatus.textContent = data.message || 'å¤„ç†ä¸­...';
}

// ä»WebSocketå¤„ç†è½¬æ¢å®Œæˆ
function handleConversionCompleteFromSocket(data) {
    document.getElementById('conversion-progress-section').classList.add('hidden');
    
    const resultContent = document.getElementById('result-content');
    
    if (data.success) {
        const outputFileName = data.output_file ? data.output_file.split('/').pop() : 'è½¬æ¢ç»“æœ';
        resultContent.innerHTML = `
            <div class="alert alert-success">
                <h4>âœ… è½¬æ¢æˆåŠŸï¼</h4>
                <p><strong>è¾“å‡ºæ–‡ä»¶ï¼š</strong>${outputFileName}</p>
                <p><strong>è½¬æ¢æ—¶é—´ï¼š</strong>${new Date(data.end_time).toLocaleString()}</p>
                <div style="margin-top: 15px;">
                    <a href="/api/download/${data.conversion_id}" class="btn btn-success">
                        ğŸ“¥ ä¸‹è½½æ–‡ä»¶
                    </a>
                </div>
            </div>
        `;
    } else {
        resultContent.innerHTML = `
            <div class="alert alert-danger">
                <h4>âŒ è½¬æ¢å¤±è´¥</h4>
                <p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${data.error || data.message}</p>
                <p><strong>å¤±è´¥æ—¶é—´ï¼š</strong>${new Date(data.end_time).toLocaleString()}</p>
            </div>
        `;
    }
    
    document.getElementById('result-section').classList.remove('hidden');
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    submitBtn.disabled = false;
    submitBtn.textContent = 'å¼€å§‹è½¬æ¢';
    
    // ç¦»å¼€è½¬æ¢æˆ¿é—´
    if (socket && currentConversionId) {
        socket.emit('leave_conversion', { conversion_id: currentConversionId });
        currentConversionId = null;
    }
}

// ä»WebSocketå¤„ç†é”™è¯¯
function handleErrorFromSocket(data) {
    document.getElementById('upload-progress-section').classList.add('hidden');
    document.getElementById('conversion-progress-section').classList.add('hidden');
    
    const resultContent = document.getElementById('result-content');
    resultContent.innerHTML = `
        <div class="alert alert-danger">
            <strong>âŒ é”™è¯¯ï¼š</strong>${data.message}
        </div>
    `;
    
    document.getElementById('result-section').classList.remove('hidden');
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    submitBtn.disabled = false;
    submitBtn.textContent = 'å¼€å§‹è½¬æ¢';
    
    // ç¦»å¼€è½¬æ¢æˆ¿é—´
    if (socket && currentConversionId) {
        socket.emit('leave_conversion', { conversion_id: currentConversionId });
        currentConversionId = null;
    }
}

// æ›´æ–°è½¬æ¢çŠ¶æ€
function updateConversionStatus(data) {
    if (data.progress !== undefined) {
        updateConversionProgressFromSocket({
            progress: data.progress,
            message: data.message
        });
    }
    
    if (data.completed) {
        handleConversionCompleteFromSocket(data);
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    validateAndUpdateUI(null);
    initWebSocket();
});
</script>

<style>
/* æ–‡ä»¶è¾“å…¥æ ·å¼ */
.file-input-wrapper {
    position: relative;
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    background-color: #fafafa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-input-wrapper:hover {
    border-color: #007bff;
    background-color: #f0f8ff;
}

.file-input-wrapper.drag-over {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.file-input-wrapper input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.file-input-overlay {
    pointer-events: none;
}

.file-input-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.file-input-text {
    font-size: 16px;
    font-weight: 500;
    color: #333;
    margin-bottom: 5px;
}

.file-input-subtext {
    font-size: 12px;
    color: #666;
}

/* æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º */
.file-info-display {
    margin-top: 15px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #007bff;
}

.file-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.file-name {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.file-icon {
    font-size: 16px;
}

.file-size-display {
    font-size: 14px;
    color: #666;
}

.size-separator {
    margin: 0 5px;
    color: #999;
}

.file-size-bar {
    display: flex;
    align-items: center;
    gap: 10px;
}

.size-bar-bg {
    flex: 1;
    height: 6px;
    background-color: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.size-bar-fill {
    height: 100%;
    background-color: #28a745;
    transition: width 0.3s ease;
}

.size-percentage {
    font-size: 12px;
    color: #666;
    min-width: 35px;
}

/* è¿›åº¦åŒºåŸŸæ ·å¼ */
.progress-section {
    margin-top: 20px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.progress-container {
    margin-top: 15px;
}

.progress-bar-wrapper {
    position: relative;
    height: 30px;
    background-color: #e9ecef;
    border-radius: 15px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #0056b3);
    border-radius: 15px;
    transition: width 0.3s ease;
    position: relative;
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: 500;
    font-size: 14px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.progress-details {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 12px;
    color: #666;
}

.progress-status {
    margin-top: 10px;
    font-size: 14px;
    color: #333;
    font-weight: 500;
}

/* ç»“æœåŒºåŸŸæ ·å¼ */
.result-section {
    margin-top: 20px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

/* éšè—ç±» */
.hidden {
    display: none !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .file-input-wrapper {
        padding: 30px 15px;
    }
    
    .file-input-icon {
        font-size: 36px;
    }
    
    .progress-details {
        flex-direction: column;
        gap: 5px;
    }
}
</style>
{% endblock %} 